name: Terraform Validate

on:
  push:
    branches: [main]
    paths:
      - 'packages/create-colloquium-journal/templates/terraform/**'
      - '.github/workflows/terraform-validate.yml'
  pull_request:
    paths:
      - 'packages/create-colloquium-journal/templates/terraform/**'
      - '.github/workflows/terraform-validate.yml'

jobs:
  validate:
    name: Validate ${{ matrix.provider }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        provider: [aws, gcp]

    defaults:
      run:
        working-directory: packages/create-colloquium-journal/templates/terraform/${{ matrix.provider }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Post Validation Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const provider = '${{ matrix.provider }}'.toUpperCase();
            const fmt = '${{ steps.fmt.outcome }}';
            const init = '${{ steps.init.outcome }}';
            const validate = '${{ steps.validate.outcome }}';

            const status = (outcome) => outcome === 'success' ? '✅' : '❌';

            const body = `### Terraform Validation Results (${provider})

            | Check | Status |
            |-------|--------|
            | Format | ${status(fmt)} |
            | Init | ${status(init)} |
            | Validate | ${status(validate)} |
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes(`Terraform Validation Results (${provider})`)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail on Format Error
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "Terraform files are not properly formatted."
          echo "Run 'terraform fmt -recursive' to fix."
          exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: packages/create-colloquium-journal/templates/terraform
          soft_fail: true

  generate-test:
    name: Test CLI Generation
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build create-colloquium-journal
        run: npm run build
        working-directory: packages/create-colloquium-journal

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Generate AWS instance
        run: |
          node packages/create-colloquium-journal/dist/index.js init "Test Journal" \
            --deployment aws \
            --region us-east-1 \
            --admin-email test@example.com

      - name: Validate generated AWS Terraform
        run: |
          cd test-journal-instance/terraform
          terraform init -backend=false
          terraform validate

      - name: Clean up AWS instance
        run: rm -rf test-journal-instance

      - name: Generate GCP instance
        run: |
          node packages/create-colloquium-journal/dist/index.js init "Test Journal" \
            --deployment gcp \
            --project-id test-project \
            --region us-central1 \
            --admin-email test@example.com

      - name: Validate generated GCP Terraform
        run: |
          cd test-journal-instance/terraform
          terraform init -backend=false
          terraform validate
